name: Upstream Sync
permissions:
  contents: write  # å¿…é¡»ï¼šå¼ºåˆ¶æ¨é€æƒé™
  issues: write    # å¿…é¡»ï¼šè‡ªåŠ¨ç®¡ç† issue
  pull-requests: write  # å¯é€‰ï¼šåˆ›å»ºåŒæ­¥ PR

on:
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶è‡ªåŠ¨åŒæ­¥
  workflow_dispatch:       # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  sync_from_upstream:
    name: Sync from upstream (è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸)
    runs-on: ubuntu-latest
    if: github.repository != 'lobehub/lobe-chat'  # ä»… fork ä»“åº“è¿è¡Œ

    steps:
      - name: Checkout code (æ£€å‡ºä»£ç )
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´ git å†å²

      - name: Clean previous failures (æ¸…ç†å¤±è´¥é€šçŸ¥)
        if: always()
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'close-issues'
          labels: 'sync-failed,ğŸš¨åŒæ­¥å¤±è´¥'  # åŒè¯­æ ‡ç­¾

      - name: Add upstream remote
        run: git remote add upstream https://github.com/lobehub/lobe-chat.git

      - name: Attempt fast-forward merge (å°è¯•å¿«é€Ÿåˆå¹¶)
        id: sync
        run: |
          git checkout main
          if git merge --ff-only upstream/main; then
            git push origin main
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "result=failure" >> $GITHUB_OUTPUT
          fi

      - name: Force sync if needed (å¼ºåˆ¶åŒæ­¥)
        if: steps.sync.outputs.result == 'failure'
        run: git push origin main --force

      - name: Create failure notice (åˆ›å»ºå¤±è´¥é€šçŸ¥)
        if: failure()
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-issue'
          title: 'ğŸš¨ Sync Failed | åŒæ­¥å¤±è´¥'
          body: |
            **EN**: Automatic sync failed! Please [sync manually](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/working-with-forks/syncing-a-fork).
            **ä¸­æ–‡**: è‡ªåŠ¨åŒæ­¥å¤±è´¥ï¼è¯·[æ‰‹åŠ¨åŒæ­¥](https://docs.github.com/zh/pull-requests/collaborating-with-pull-requests/working-with-forks/syncing-a-fork).
